package fr.epsi.router;

import java.io.IOException;

import javax.ejb.EJB;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import fr.epsi.entite.Roles;
import fr.epsi.entite.User;
import fr.epsi.entite.UserRole;
import fr.epsi.service.RolesService;
import fr.epsi.service.UserRoleService;
import fr.epsi.service.UserService;

@WebServlet("/")
public class HomeServlet extends HttpServlet{
	
	@EJB
	private UserService userService;
	
	@EJB
	private RolesService rolesService;	
	
	@EJB
	private UserRoleService userRoleService;	
	
	 protected void doGet(HttpServletRequest req, HttpServletResponse resp)
		        throws ServletException, IOException
		    {		 				 HttpSession session = req.getSession();
		    
			    // On crée un compte administrateur
		 		// Il ne sera pas possible de le faire depuis le site web pour le moment (évolution)			
				// session.setAttribute("admin", true);
			    User u=new User();
				u.setMail("root");
				u.setPassword("root");
				userService.createUser(u);	
				System.out.println("onessaiedetrouverlid");
				Long user_id = u.getId();
				System.out.println(user_id);
				
				//On crée le role				
				Roles r =new Roles();
				r.setRoleDescription("Admin");
				Long role_id = r.getId();
				System.out.println(role_id);
				rolesService.createRole(r);
				//On crée l'association Role-User
				UserRole ur =new UserRole();
				System.out.println("onregardesittvabien");
				System.out.println(user_id);
				System.out.println(role_id);
				ur.setRolesId(role_id);
				ur.setUserId(user_id);
				userRoleService.createUserRole(ur);
			
				 if(session.getAttribute("connected") != null) {
					 if((Boolean)session.getAttribute("connected")) 
					 {
						 this.getServletContext().getRequestDispatcher("/WEB-INF/pages/PageHome.jsp").forward(req, resp); 
					 }else {
						 this.getServletContext().getRequestDispatcher("/WEB-INF/pages/connexion/FormConnexion.jsp").forward(req, resp);
					 }
				 }
				 else 
				 {
					 this.getServletContext().getRequestDispatcher("/WEB-INF/pages/connexion/FormConnexion.jsp").forward(req, resp);
				 }
			}

}
