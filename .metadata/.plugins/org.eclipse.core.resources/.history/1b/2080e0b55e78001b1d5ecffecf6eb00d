package fr.epsi.servlet;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import javax.ejb.EJB;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import fr.epsi.entite.Idee;
import fr.epsi.entite.User;
import fr.epsi.entite.Vote;
import fr.epsi.service.IdeeService;
import fr.epsi.service.UserService;
import fr.epsi.service.VoteService;


@WebServlet("/idees")
public class IdeeServlet extends HttpServlet{
	
	@EJB
	private IdeeService ideeService;
	
	@EJB
	private VoteService voteService;
	
	@EJB
	private UserService userService;
	
	
	 protected void doGet(HttpServletRequest req, HttpServletResponse resp)
		        throws ServletException, IOException
		    {
		 		if(req.getParameter("action").equals("list")) {
		 			Object objSessionId = req.getSession().getAttribute("SessionID");
					 long sessionId =  Long.parseLong( String.valueOf(objSessionId));
		 			req.setAttribute("IdeesList", this.getIdeesList(sessionId));		
			 		this.getServletContext().getRequestDispatcher("/WEB-INF/pages/IdeeInnovante/ListIdee.jsp").forward(req, resp);
		 		}else if(req.getParameter("action").equals("create")) {
			 		this.getServletContext().getRequestDispatcher("/WEB-INF/pages/IdeeInnovante/FormIdee.jsp").forward(req, resp);
		 		}
		 		
		    }
		 	
		 protected void doPost(HttpServletRequest req, HttpServletResponse resp)
			        throws ServletException, IOException
			    {
					 if(req.getParameter("action") != null)
					 {
						 if(req.getParameter("action").equals("vote"))
						 {
							 //id de l'entité Idee
							 Long ideeId = Long.parseLong(req.getParameter("ideeId"));
							 //l'entier top/flop
							 int vote = Integer.parseInt(req.getParameter("vote"));
							 //l'id de l'utilisateur connecté
							 Object objSessionId = req.getSession().getAttribute("SessionID");
							 long sessionId =  Long.parseLong( String.valueOf(objSessionId));
							 this.setVote(ideeId, sessionId, vote); 
					 		 req.setAttribute("IdeesList", this.getIdeesList(sessionId));		
							 this.getServletContext().getRequestDispatcher("/WEB-INF/pages/IdeeInnovante/ListIdee.jsp").forward(req, resp);
					 	 }
						 else if(req.getParameter("action").equals("create")) {
							 Object objSessionId = req.getSession().getAttribute("SessionID");
							 long sessionId =  Long.parseLong( String.valueOf(objSessionId));
							 this.create(req.getParameter("categorieIdee"), req.getParameter("descriptionIdee"), req.getParameter("imgIdee"),sessionId);	
				 			 req.setAttribute("IdeesList", this.getIdeesList(sessionId));		
				 			 this.getServletContext().getRequestDispatcher("/WEB-INF/pages/IdeeInnovante/ListIdee.jsp").forward(req, resp);
					 	 }
					 }
			   		
			    }
		 
		 public List<Idee> getIdeesList(long userId) {	
			 	//Init de la liste pour première utilisation,
			 	// nous ajouterons nos articles avec le formulaire par la suite.
				 if(ideeService.getIdeesList().isEmpty()){
					 // Je dois récupérer les images depuis internet je rencontre des difficultés à les récupérer en local
				 	this.init("Fun", "Parler après avoir réspiré dans un ballon d'hélium ", "https://media.logicielmac.com/download/300x300/productivite/c9e0b6f6-effet-ballon-d-helium-gratuit.jpg", userId); 
				 	this.init("Serieuse", "Résoudre un problème mathématique non résolu", "https://image.freepik.com/photos-gratuite/calculs-mathematiques-tableau-noir_100488-354.jpg", userId); 
				 	this.init("Fun", "Parler après avoir réspiré dans un ballon d'hélium1 ", "https://media.logicielmac.com/download/300x300/productivite/c9e0b6f6-effet-ballon-d-helium-gratuit.jpg", userId); 
				 	this.init("Serieuse", "Résoudre un problème mathématique non résolu2", "https://image.freepik.com/photos-gratuite/calculs-mathematiques-tableau-noir_100488-354.jpg", userId); 
				 	this.init("Fun", "Parler après avoir réspiré dans un ballon d'hélium3 ", "https://media.logicielmac.com/download/300x300/productivite/c9e0b6f6-effet-ballon-d-helium-gratuit.jpg", userId); 
				 	this.init("Serieuse", "Résoudre un problème mathématique non résolu4", "https://image.freepik.com/photos-gratuite/calculs-mathematiques-tableau-noir_100488-354.jpg", userId); 
				 	this.init("Fun", "Parler après avoir réspiré dans un ballon d'hélium5 ", "https://media.logicielmac.com/download/300x300/productivite/c9e0b6f6-effet-ballon-d-helium-gratuit.jpg", userId); 
				 	this.init("Serieuse", "Résoudre un problème mathématique non résolu6", "https://image.freepik.com/photos-gratuite/calculs-mathematiques-tableau-noir_100488-354.jpg", userId); 
				 	
				 }
			 	List<Idee> idees=new ArrayList<Idee>();		
			 	idees = ideeService.getIdeesList();		
				return idees;			
			}
		 
		 // On init notre liste avec l'utilisateur root
		 public void init(String categorie, String description, String Image, long userId) {
			 	Idee i=new Idee();
				i.setCategorie(categorie);
				i.setDescription(description);	
				i.setImage(Image);
				i.setDateEmission(new Date());
				i.setUser(userService.getUserOnId(userId)); 
				ideeService.createIdee(i);	
				for (int x = 0; x < (Math.random() * 10 + 1) ; x++) {
					this.setVote(i.getId(), userId, (int) ( Math.random() * 2 + 1));
				}

			}
		 
		 public void create(String categorie, String description, String Image, long userId) {
			 	Idee i=new Idee();
				i.setCategorie(categorie);
				i.setDescription(description);	
				i.setImage(Image);
				i.setDateEmission(new Date());
				i.setUser(userService.getUserOnId(userId)); 
				ideeService.createIdee(i);	
			}
		 
		 public void setVote(Long ideeId, Long sessionID, int vote) {
			 	Idee i = ideeService.getIdee(ideeId);
			 	User u = userService.getUserOnId(sessionID);			 	
			 	Vote v = new Vote();
			 	//vote du param (int)
			 	v.setLabelVote(vote);
			 	v.setUser(u);
			 	v.setIdee(i);
			 	voteService.createVote(v);
			}
}
